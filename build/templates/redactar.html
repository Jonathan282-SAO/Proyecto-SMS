<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redactar Mensaje - Sistema de Alertas</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{url_for('static',filename='css/redactar.css')}}">
</head>
<body>
    <!-- Banner superior -->
    <div class="banner">
        <div class="banner-left">
            <span class="icono-baner"></span>
            <span class="notificaciones">Notificaciones Masivas</span>
        </div>
        <div class="banner-right">
            <span class="welcome-text">Bienvenido(a)</span>
            <span class="user-dropdown-toggle user-name" onclick="toggleUserDropdown()">{{ usuario }}</span>
            <div class="user-dropdown" id="userDropdown">
                <ul>
                    <li><a href="{{ url_for('change_password') }}">Cambiar contraseña</a></li>
                    <li><a href="{{ url_for('logout') }}">Cerrar sesión</a></li>
                </ul>
            </div>
        </div>
    </div>
    
    <!-- Barra de menú -->
    <div class="menu-bar">
        <ul class="menu-list">
            <li><a href="{{ url_for('home') }}">Inicio</a></li>
            <li><a href="{{ url_for('grupos') }}">Grupos</a></li>
            <li><a href="{{ url_for('notificaciones') }}">Notificaciones</a></li>
            <li class="active"><a href="{{ url_for('redactar') }}">Redactar</a></li>
            <li><a href="{{ url_for('ayuda') }}">Ayuda</a></li>
        </ul>
    </div>
    
    <!-- Cuadro de Redacción -->
    <form action="{{ url_for('redactar') }}" method="POST">
        <div class="redactar-card">
            <!-- Encabezado -->
            <div class="redactar-header">
                <img src="{{ url_for('static', filename='images/icono_seccion_redactar.png') }}" alt="Icono Redactar" class="icono-redactar">
                <span>Redactar Mensaje</span>
            </div>
            
            <!-- Cuerpo -->
            <div class="redactar-body">
                <div class="form-group">
                    <label for="grupos" class="form-label">Seleccionar grupos:</label>
                    <select id="grupos" name="grupo" class="form-select" required>
                        <option value="">Seleccione un grupo...</option>
                        {% for grupo in grupos %}
                        <option value="{{ grupo.id }}">{{ grupo.nombre }}</option>
                        {% endfor %}
                    </select>

                    <div class="opciones-modalidad mt-3">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" id="correo" name="modalidad" value="correo" required>
                            <label class="form-check-label" for="correo">Correo Electrónico</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" id="sms" name="modalidad" value="sms">
                            <label class="form-check-label" for="sms">SMS</label>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="asunto-input" class="form-label">Asunto:</label>
                    <input type="text" id="asunto-input" name="asunto" class="form-control" placeholder="Asunto del mensaje" required>
                </div>
                
                <div class="form-group">
                    <label for="mensaje-textarea" class="form-label">Mensaje:</label>
                    <textarea id="mensaje-textarea" name="mensaje" class="form-control" placeholder="Escribe el mensaje aquí..." required></textarea>
                </div>
                
                <div class="nota">
                    <small>⚠️ El texto no puede contener caracteres especiales ni la letra "ñ"</small>
                </div>
            </div>
            
            <!-- Pie -->
            <div class="redactar-footer">
                <button type="submit" class="enviar-button">
                    <img src="{{ url_for('static', filename='images/icono_enviar.png') }}" alt="Icono Enviar" class="icono-enviar">
                    Enviar Mensaje
                </button>
            </div>
        </div>
    </form>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-left">
            <div class="footer-column">
                <a href="https://www.etecsa.cu/">Nuestra Empresa</a>
                <a href="https://www.etecsa.cu/es/noticias/nota-informativa">Noticias</a>
            </div>
            <div class="footer-column">
                <a href="https://www.google.com/url?sa=t&source=web&rct=j&opi=89978449&url=https://www.youtube.com/channel/UCL0haKOFpVzhnKW3xSZJx9g/videos&ved=2ahUKEwjEl7nGz9uNAxX9nK8BHXnFML8QFnoECBUQAQ&usg=AOvVaw1mq5OFoaKhA0cx4T7ZyC-k">Multimedia</a>
                <a href="https://portal.etecsa.cu/portalApp/listado">Servicios Internos</a>
            </div>
        </div>
        <div class="footer-right">
            <img src="{{ url_for('static', filename='images/icono_logo.png') }}" alt="Logo">
            <span>&copy; {{ year }} Empresa de Telecomunicaciones de Cuba S.A (ETECSA)</span>
        </div>
    </footer>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Scripts personalizados -->
    <script>
        function toggleUserDropdown() {
            const dropdown = document.getElementById("userDropdown");
            dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
        }

        // Cerrar el menú si se hace clic fuera de él
        document.addEventListener("click", function(event) {
            const dropdown = document.getElementById("userDropdown");
            const toggle = document.querySelector(".user-dropdown-toggle");
            if (dropdown.style.display === "block" && !dropdown.contains(event.target) && event.target !== toggle) {
                dropdown.style.display = "none";
            }
        });

        // Validación de caracteres especiales
        document.getElementById('mensaje-textarea').addEventListener('input', function(e) {
            const texto = this.value;
            // Expresión regular que permite letras, números, espacios y puntuación básica
            const textoLimpio = texto.replace(/[^a-zA-Z0-9\s.,!?¿¡()\-]/g, '');
            if (texto !== textoLimpio) {
                this.value = textoLimpio;
                alert('Se han removido caracteres especiales. No se permiten acentos, ñ ni símbolos especiales.');
            }
        });

        // Validación del formulario antes de enviar
        document.querySelector('form').addEventListener('submit', function(e) {
            const mensaje = document.getElementById('mensaje-textarea').value;
            const asunto = document.getElementById('asunto-input').value;
            const grupo = document.getElementById('grupos').value;
            const modalidad = document.querySelector('input[name="modalidad"]:checked');
            
            // Validar que se haya seleccionado una modalidad
            if (!modalidad) {
                e.preventDefault();
                alert('Por favor, seleccione una modalidad de envío (Correo o SMS).');
                return;
            }
            
            // Validar que se haya seleccionado un grupo
            if (!grupo) {
                e.preventDefault();
                alert('Por favor, seleccione un grupo destino.');
                return;
            }
            
            // Validar caracteres especiales en el asunto
            if (/[ñáéíóúÑÁÉÍÓÚ]/.test(asunto)) {
                e.preventDefault();
                alert('El asunto no puede contener la letra "ñ" ni caracteres con acento.');
                return;
            }
            
            // Mostrar confirmación antes de enviar
            if (!confirm('¿Está seguro de que desea enviar este mensaje?')) {
                e.preventDefault();
            }
        });
    </script>
</body>
</html>