{% extends 'base.html' %}
{% block title %}Grupos - {{ system_name }}{% endblock %}
{% block head_extras %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/grupo.css') }}">
{% endblock %}
{% block content %}
<!-- Banner superior -->
<div class="banner">
  <div class="banner-left">
    <span class="icono-baner"></span>
    <span class="notificaciones">{{ system_name }}</span>
  </div>
  <div class="banner-right">
    <span class="welcome-text">Bienvenido(a)</span>
    <span class="user-dropdown-toggle user-name" onclick="toggleUserDropdown()">{{ usuario }}</span>
    <div class="user-dropdown" id="userDropdown">
      <ul>
        {% if session.get('role') == 'admin' %}
          <li><a href="{{ url_for('admin.admin') }}">Panel Admin</a></li>
        {% endif %}
        <li><a href="{{ url_for('main.change_password') }}">Cambiar contraseña</a></li>
        <li><a href="{{ url_for('main.logout') }}">Cerrar sesión</a></li>
      </ul>
    </div>
  </div>
</div>

<!-- Barra de menú con búsqueda -->
<div class="menu-bar">
  <ul class="menu-list">
    <li><a href="{{ url_for('main.home') }}">Inicio</a></li>
    <li class="active"><a href="{{ url_for('main.grupos') }}">Grupos</a></li>
    <li><a href="{{ url_for('main.notificaciones') }}">Notificaciones</a></li>
    <li><a href="{{ url_for('main.redactar') }}">Redactar</a></li>
    <li><a href="{{ url_for('main.ayuda') }}">Ayuda</a></li>
  </ul>
</div>

<!-- Contenido principal -->
<div class="grupos-content">
  <!-- Tarjeta de Grupos -->
  <div class="grupos-card">
    <!-- Encabezado general de la tarjeta -->
    <div class="grupos-card-header">
      <div class="header-left">
        <img
          src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iY3VycmVudENvbG9yIj48cGF0aCBkPSJNMTIgMTJjMi4yMSAwIDQtMS43OSA0LTRzLTEuNzktNC00LTQtNCAxLjc5LTQgNCAxLjc5IDQgNCA0em0wIDJjLTIuNjcgMC04IDEuMzQtOCA0djJoMTZ2LTJjMC0yLjY2LTUuMzMtNC04LTR6Ii8+PC9zdmc+"
          alt="Icono Grupo">
        <span>MIS GRUPOS</span>
      </div>
      <div class="header-right">
        <button onclick="openModal()">Crear Grupo</button>
        <!-- Ícono de filtro -->
        <img
          src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iY3VycmVudENvbG9yIj48cGF0aCBkPSJNMTAgMThoNHYtMmgtNHYyek0zIDZ2MmgxOFY2SDN6bTMgN2gxMnYtMkg2djJ6Ii8+PC9zdmc+"
          alt="Icono Filtro" class="icono-filtro" onclick="toggleFilterMenu(event)">
        <span id="filterLabel" class="filter-label" style="display:none; margin-left:8px; padding:4px 8px; border-radius:12px; background:#fff; color:var(--primary-color); font-weight:600; font-size:0.9rem; box-shadow:0 2px 6px rgba(0,0,0,0.08);">Filtro</span>
      </div>
      <!-- Mini menú de filtrado (desplegable) -->
      <div id="filterMenu" class="filter-menu" style="display: none;">
        <ul>
          <li onclick="sortGroupsBy('services')">Mayor cantidad de usuarios</li>
          <li onclick="sortGroupsBy('messages')">Mayor cantidad de mensajes enviados</li>
        </ul>
      </div>
    </div>

    <!-- Barra pivot: encabezado de columnas -->
    <div class="group-row group-header">
      <div class="group-name">Nombre del Grupo</div>
      <div class="group-services">Número de Usuarios</div>
      <div class="group-messages">Mensajes Enviados</div>
      <div class="group-actions">Acciones</div>
    </div>

    <!-- Contenedor donde se agregarán los grupos creados -->
    <div id="groupsList" class="groups-list">
      {% for g in grupos %}
      <div class="group-row">
        <div class="group-name">{{ g.nombre }}</div>
        <div class="group-services">{{ g.usuarios|length }}</div>
        <div class="group-messages">{{ g.mensajes|length if g.mensajes else 0 }}</div>
        <div class="group-actions">
          <button type="button" class="btn btn-sm btn-outline-secondary edit-button" 
                  data-id="{{ g.id }}" 
                  data-name="{{ g.nombre|e }}" 
                  data-users="{% for u in g.usuarios %}{{ u.id }}{% if not loop.last %},{% endif %}{% endfor %}">
            Editar
          </button>
          <button type="button" class="btn btn-sm btn-outline-danger ms-2 delete-button" 
                  data-id="{{ g.id }}" data-name="{{ g.nombre|e }}">Eliminar</button>
        </div>
      </div>
      {% else %}
      <div class="group-row">
        <div class="group-name">No hay grupos creados.</div>
      </div>
      {% endfor %}
    </div>
    <!-- Modal de Crear Grupo -->
    <div id="modal" class="modal" style="display:none;">
      <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2>Crear grupo</h2>

        <!-- FORMULARIO REAL -->
        <form method="POST" action="{{ url_for('main.grupos') }}">
          {%- if form is defined and form.csrf_token is defined -%}
            {{ form.csrf_token }}
          {%- elif csrf_token is defined -%}
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          {%- endif -%}

          <!-- Nombre del grupo -->
          <div class="group-input">
            <input type="text" name="nombre" placeholder="Nombre del grupo" required>
          </div>

          <!-- Usuarios seleccionados se insertarán aquí -->
          <div class="services-box" id="servicesBox">
          </div>

          <!-- Botón para abrir modal de usuarios -->
          <button type="button" onclick="openServicesModal()">Añadir Usuario</button>

          <div class="modal-footer">
            <button type="button" onclick="closeModal()">Cancelar</button>
            <button type="submit">Aceptar</button>
          </div>

        </form>
      </div>
    </div>

    <!-- Modal de Editar Grupo (rellenado dinámicamente) -->
    <div id="editGroupModal" class="modal" style="display:none;">
      <div class="modal-content">
        <span class="close" onclick="closeEditModal()">&times;</span>
        <h2 class="modal-title">Editar Grupo</h2>

        <form id="editGroupForm" method="POST" action="{{ url_for('main.editar_grupo', id=0) }}" data-action-template="{{ url_for('main.editar_grupo', id=0) }}">
          {%- if form is defined and form.csrf_token is defined -%}
            {{ form.csrf_token }}
          {%- elif csrf_token is defined -%}
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          {%- endif -%}

          <div class="group-input">
            <label for="edit_nombre" class="form-label">Nombre del grupo</label>
            <input type="text" id="edit_nombre" name="nombre" class="form-control" required>
          </div>

          <h5 class="mt-3">Seleccionar usuarios</h5>
          <div class="border p-3 rounded mb-3" style="max-height: 320px; overflow-y: auto;">
            {% for u in usuarios %}
            <div class="form-check">
              <input class="form-check-input edit-user-checkbox" type="checkbox" name="usuarios" value="{{ u.id }}" id="edit_user{{ u.id }}">
              <label class="form-check-label" for="edit_user{{ u.id }}">{{ u.username }} ({{ u.email or 'sin email' }})</label>
            </div>
            {% endfor %}
          </div>

          <div class="modal-footer">
            <button type="button" class="btn" onclick="closeEditModal()">Cancelar</button>
            <button type="submit" class="btn btn-primary">Guardar cambios</button>
          </div>
        </form>
      </div>
    </div>

      <!-- Modal de Confirmación de Eliminación -->
      <div id="deleteGroupModal" class="modal" style="display:none;">
        <div class="modal-content">
          <span class="close" onclick="closeDeleteModal()">&times;</span>
          <h2 class="modal-title">Eliminar Grupo</h2>
          <div style="padding:20px;">
            <p>¿Estás seguro que deseas eliminar el grupo <strong id="deleteGroupName"></strong>?</p>
            <form id="deleteGroupForm" method="POST" action="{{ url_for('main.eliminar_grupo', id=0) }}" data-action-template="{{ url_for('main.eliminar_grupo', id=0) }}">
              {%- if form is defined and form.csrf_token is defined -%}
                {{ form.csrf_token }}
              {%- elif csrf_token is defined -%}
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              {%- endif -%}
              <div style="display:flex; justify-content:flex-end; gap:12px; margin-top:14px;">
                <button type="button" class="btn" onclick="closeDeleteModal()">Cancelar</button>
                <button type="submit" class="btn btn-danger">Confirmar eliminación</button>
              </div>
            </form>
          </div>
        </div>
      </div>

    <!-- Modal de Añadir Servicios -->
    <div id="servicesModal" class="modal" style="display:none;">
      <div class="modal-content">
        <span class="close" onclick="closeServicesModal()">&times;</span>
        <!-- Encabezado con título y barra de búsqueda -->
        <div class="modal-header">
          <h2>Añadir Usuarios</h2>
          <input type="text" id="serviceSearch" placeholder="Buscar Usuario">
        </div>
        <!-- Cuerpo: cuadro con servicios posibles -->
        <div class="modal-body">
          <div class="services-table">
            <table>
              <thead>
                <tr>
                  <th>Seleccionar</th>
                  <th>Nombre del Usuario</th>
                  <th>Correo Electrónico</th>
                  <th>Número de Teléfono</th>
                </tr>
              </thead>
              <tbody id="servicesTableBody">
                {% for u in usuarios %}
                <tr class="{{ 'admin-user' if (u.role == 'admin') else '' }}">
                  <td><input type="checkbox" class="service-checkbox" value="{{ u.id }}" data-username="{{ u.username|e }}" data-role="{{ u.role|e }}"></td>
                  <td class="user-name-cell">{{ u.username or ('ID ' ~ u.id) }}</td>
                  <td>{{ u.email or '—' }}</td>
                  <td>{{ u.telefono or '—' }}</td>
                </tr>
                {% endfor %}
              </tbody>

            </table>
          </div>
        </div>
        <!-- Pie del modal de Servicios -->
        <div class="modal-footer">
          <button type="button" onclick="closeServicesModal()">Cancelar</button>
          <button type="button" onclick="acceptServicesModal()">Aceptar</button>
        </div>
        </div>
      </div>
    </div>

    {% endblock %}

    {% block scripts %}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/grupos.js') }}"></script>
    {% endblock %}